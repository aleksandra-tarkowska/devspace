<?xml version='1.0' encoding='UTF-8'?>
<project>
  <actions/>
  <description></description>
  <keepDependencies>false</keepDependencies>
  <properties/>
  <scm class="hudson.scm.NullSCM"/>
  <assignedNode>web</assignedNode>
  <canRoam>false</canRoam>
  <disabled>false</disabled>
  <blockBuildWhenDownstreamBuilding>false</blockBuildWhenDownstreamBuilding>
  <blockBuildWhenUpstreamBuilding>false</blockBuildWhenUpstreamBuilding>
  <triggers/>
  <concurrentBuild>false</concurrentBuild>
  <builders>
    <hudson.tasks.Shell>
      <command>
OMERO_DIST=$WORKSPACE/OMERO.web
if [ -e $OMERO_DIST ]; then
    if [ -e $WORKSPACE/omero-virtualenv ]; then
        source $WORKSPACE/omero-virtualenv/bin/activate
        $OMERO_DIST/bin/omero web stop || echo &apos;not running&apos;
        sleep 5
        $OMERO_DIST/bin/omero web status || echo &apos;no status&apos;
        deactivate
    fi
fi

rm -rf $HOME/static/web/
rm -rf $WORKSPACE/*
      </command>
    </hudson.tasks.Shell>
    <hudson.plugins.copyartifact.CopyArtifact plugin="copyartifact@1.37">
      <project>OMERO-build</project>
      <filter>src/target/OMERO.py*zip</filter>
      <target></target>
      <excludes></excludes>
      <selector class="hudson.plugins.copyartifact.StatusBuildSelector"/>
      <flatten>true</flatten>
      <doNotFingerprintArtifacts>false</doNotFingerprintArtifacts>
    </hudson.plugins.copyartifact.CopyArtifact>
    <hudson.tasks.Shell>
      <command>
OMERO_DIST=$WORKSPACE/OMERO.web
OMERO_INSTALL=/tmp/omero-install/linux

ZIP=$(ls OMERO.py*.zip)
DIST=${ZIP%.zip}
unzip $ZIP
rm -f $ZIP
mv $WORKSPACE/$DIST $OMERO_DIST

virtualenv $WORKSPACE/omero-virtualenv --system-site-packages
source $WORKSPACE/omero-virtualenv/bin/activate

source $OMERO_INSTALL/settings.env

pip install -r $OMERO_DIST/share/web/requirements-py27-nginx.txt
pip install &quot;django-redis-cache&gt;=1.6.5&quot;
pip install gevent

if [ $ICEVERSION = &quot;noice&quot; ]; then
    pip install &quot;zeroc-ice&gt;3.5,&lt;3.7&quot;
fi

pip install &apos;git+git://github.com/aleksandra-tarkowska/mapannotations.git&apos;


# custom config

$OMERO_DIST/bin/omero config set omero.web.wsgi_worker_class gevent
$OMERO_DIST/bin/omero config set omero.web.wsgi_worker_connections 1000
$OMERO_DIST/bin/omero config set omero.web.application_server.max_requests 0
$OMERO_DIST/bin/omero config set omero.web.wsgi_workers 10
$OMERO_DIST/bin/omero config set -- omero.web.wsgi_args &apos;--backlog 2048&apos;



$OMERO_DIST/bin/omero config set omero.web.public.enabled true
$OMERO_DIST/bin/omero config set omero.web.public.user &apos;public&apos;
$OMERO_DIST/bin/omero config set omero.web.public.password &apos;ome&apos;
$OMERO_DIST/bin/omero config set omero.web.public.server_id 1
$OMERO_DIST/bin/omero config set omero.web.public.url_filter &apos;^/(?!webadmin|webclient/logout)&apos;
$OMERO_DIST/bin/omero config set omero.web.ui.top_links &apos;[[&quot;IDR&quot;, {&quot;viewname&quot;: &quot;webindex&quot;, &quot;query_string&quot;: {&quot;experimenter&quot;: -1}}, {&quot;title&quot;: &quot;Image Data Repository&quot;}], [&quot;Genes&quot;, {&quot;viewname&quot;: &quot;maprindex_gene&quot;, &quot;query_string&quot;: {&quot;experimenter&quot;: -1}}, {&quot;title&quot;: &quot;Genes browser&quot;}], [&quot;Phenotypes&quot;, {&quot;viewname&quot;: &quot;maprindex_phenotype&quot;, &quot;query_string&quot;: {&quot;experimenter&quot;: -1}}, {&quot;title&quot;: &quot;Phenotypes browser&quot;}], [&quot;siRNA&quot;, {&quot;viewname&quot;: &quot;maprindex_sirna&quot;, &quot;query_string&quot;: {&quot;experimenter&quot;: -1}}, {&quot;title&quot;: &quot;siRNA browser&quot;}], [&quot;Compound&quot;, {&quot;viewname&quot;: &quot;maprindex_compound&quot;, &quot;query_string&quot;: {&quot;experimenter&quot;: -1}}, {&quot;title&quot;: &quot;Compound browser&quot;}], [&quot;History&quot;, &quot;history&quot;, {&quot;title&quot;: &quot;History&quot;}], [&quot;About&quot;, &quot;/about/&quot;], [&quot;Help&quot;, &quot;http://help.openmicroscopy.org/&quot;, {&quot;title&quot;:&quot;Open OMERO user guide in a new tab&quot;, &quot;target&quot;:&quot;new&quot;}]]&apos;
$OMERO_DIST/bin/omero config append omero.web.apps &apos;&quot;mapr&quot;&apos;

#start-config
$OMERO_DIST/bin/omero config set omero.web.application_server &apos;wsgi-tcp&apos;
$OMERO_DIST/bin/omero config set omero.web.application_server.max_requests 0

$OMERO_DIST/bin/omero config set omero.web.prefix $WEB_PREFIX
$OMERO_DIST/bin/omero config set omero.web.static_url $WEB_PREFIX&apos;/static/&apos;
$OMERO_DIST/bin/omero config set omero.web.static_root $HOME&apos;/static/web/&apos;

$OMERO_DIST/bin/omero config set omero.web.session_engine &apos;django.contrib.sessions.backends.cache&apos;
$OMERO_DIST/bin/omero config set omero.web.caches &apos;{&quot;default&quot;: {&quot;BACKEND&quot;: &quot;redis_cache.RedisCache&quot;,&quot;LOCATION&quot;: &quot;redis:6379&quot;}}&apos;

$OMERO_DIST/bin/omero config set omero.web.server_list &apos;[[&quot;omero&quot;, 4064, &quot;omero&quot;], [&quot;testintegration&quot;, 14064, &quot;testintegration&quot;]]&apos;

$OMERO_DIST/bin/omero config set omero.web.application_server.host web
$OMERO_DIST/bin/omero config set omero.web.application_server.port 4080

$OMERO_DIST/bin/omero web config nginx --servername &quot;10.0.51.133&quot; --http &quot;$OMERO_WEB_PORT&quot; &gt;$OMERO_DIST/nginx.conf.tmp

sudo cp $OMERO_DIST/nginx.conf.tmp $HOME/nginx/$NODE_NAME.conf

$OMERO_DIST/bin/omero config set omero.web.wsgi_args -- &apos;--log-level=DEBUG --error-logfile=/home/omero/workspace/OMERO-web/OMERO.web/var/log/gunicorn.err&apos;

$OMERO_DIST/bin/omero config set omero.web.application_server.host 0.0.0.0

BUILD_ID=DONT_KILL_ME $OMERO_DIST/bin/omero web start

deactivate
      </command>
    </hudson.tasks.Shell>
  </builders>
  <publishers/>
  <buildWrappers/>
</project>